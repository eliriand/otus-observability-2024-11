# Домашнее задание 1

В качестве CMS используется Wordpress, установленный на хосте 10.0.0.5 (публичный адрес 87.242.118.70), там же настроены экспортеры для сбора метрик
## Стек CMS

Nginx отдает статистику через UNIX-сокет /var/run/nginx-status.sock по пути /nginx_status

PHP-FPM отдает статистику по tcp://127.0.0.1:9001/status

Для забора статистики используем отдельного пользователя в БД, подключаясь к стандартному порту 3306
## Настроенные экспортеры
Node Exporter - сбор основных метрик системы

NGINX Exporter - сбор метрик с NGINX

PHP-FPM Exporter - сбор метрик сервиса php-fpm

MYSQLD Exporter - сбор статистики с БД

Blackbox exporter - выполнение HTTP-чеков по корню главной страницы сайта

Exporter exporter - проксирование прочих экспортеров, чтоб избежать необходимости выставлении порта для каждого отдельно, слушает порт 9999
## Prometheus
Настроен на хосте 10.0.0.6 (публичный адрес http://213.171.28.17:9090)

Все подключения к экспортерам выполняются через проксирующий Exporter exporter по порту 9999

Для выбора целевого экспортера на наблюдаемой машине используется параметр module
## Структура репозитория
Две Ansible роли для установки экспортеров и настройки Prometheus: roles/exporters и roles/prometheus

Роль exporters скачивает и устанавливает все указанные экспортеры в виде сервисов, конфигурационные файлы находятся в roles/exporters/templates

Роль prometheus скачивает, устанавливает и конфигурирует сам Prometheus. Основной конфигурационный файл - roles/prometheus/templates/prometheus.yml.j2, в нем описано подключение ко всем настроенным ранее экспортерам
## Запуск решения

Установить зависимости: pip3 install -r -requirements.txt (Опционально делать это в виртуальном окружении, чтоб не "запачкать" свою систему)

Настроить инвентарь в inventory.yml, вписав нужные адреса хостов

Добавить приватный ключ, указать его в ansible.cfg

Запустить установку экспортеров: ansible-playbook -i inventory.yml --ask-vault-pass exporters.yml

В ходе установки ввести пароль от ansible-vault (требуется для конфигурирования подключения mysqld exporter к базе данных)

Запустить установку Prometheus: ansible-playbook -i inventory.yml prometheus.yml

Перейти на страницу http://213.171.28.17:9090
